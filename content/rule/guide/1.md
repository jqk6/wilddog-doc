/*
Title: 1. 理解 Wilddog 的安全策略
Sort: 1
Tmpl : page-guide
*/

## 1. 理解 Wilddog 的安全策略

Wilddog 提供了一套完整的安全策略来保障安全。使用这些工具能更容易的控制用户身份验证以及数据的访问权限，并校验数据输入的正确性。

####  概述

安全是一个非常重大的话题，也是应用开发中的一个难点。使用Wilddog开发你的App，安全变的简单许多。有的方面彻底交给我们就可以了，比如管理App的用户和密码；我们不能完全处理的地方，我们都做到最简化，例如我们提供了一种声明式的语言，用于保护你的数据安全。


#### 身份认证

每个用户都有一个唯一ID，在Wilddog的安全策略中起到很重要的作用。不同的用户有不同的数据访问权限，有时不同用户也有不同的功能。例如，在聊天程序中，每个消息与创建它的用户相关联。用户可以删除自己的消息，但不能删除其他用户的消息。想要确保安全，第一步是识别用户合法性，这个过程就是auth认证。

Wilddog 提供三种auth机制，

* Email和password登录。Wilddog提供了用户账户管理功能。
* 集成微博第三方登录。
* Custom token登录，使用你已有的账户体系登录。


#### 用户授权
用户身份认证只是安全体系中的一部分。一旦确认了用户身份，还需要一种机制来控制对数据的访问权限。
Wilddog提供了一种声明式的语言来编写“规则表达式”，这些规则在Wilddog云端保护App数据。你可以进入Wilddog的控制面板，选择一个应用进行管理，在“规则表达式”中编辑这个规则。
通过这个规则表达式，你可以控制任何一个数据节点的访问权限。在任何一个数据节点上适用的规则，将会自动延展到所有子节点。

```json

{

  "rules": {

    "foo": {

      ".read": true,

      ".write": false

    }

  }

}

```

这个规则示例使任何人都有权限读取 `/foo` 节点和它的所有子节点的数据，但禁止任何人修改数据。
Wilddog的规则表达式中包含一些内置的变量和函数，可用于构建规则表达式表达式。这些变量和函数功能强大，使得表达式中可以引用其它数据节点，云端时间戳等。
其中最重要的内置变量是`auth` 对象，它代表用户的身份信息，包含用户唯一标识`auth.uid` 和 用户登录方式`auth.provider`。`auth` 对象是许多规则的基础。

```json

{

  "rules": {

    "users": {

      "$user_id": {

        ".write": "$user_id == auth.uid"

      }

    }

  }

}

```
规则中以`$`开头的路径$user_id是一个动态路径。这个规则授予用户`/users/<auth.uid>/`的写权限，当用户的唯一id与规则中动态路径变量相匹配时。

#### 数据校验

Wilddog是一个schema-free的数据库。但是应用数据的一致性是很重要的。 规则表达式引擎中包含一个`.validate`规则。它的使用和`.read`，`.write`相同，唯一的区别是`.validate`规则不会自动延展到子节点。

```json

{

  "rules": {

    "foo": {

      ".validate": "newData.isString() && newData.val().length < 100"

    }

  }

}

```

这条规限制强制写入`/foo`时，必须是长度少于100的字符串。

`.validate`规则中可以使用所有的`.read`和`.write`规则的内置对象。同样可以使用 `auth`等对象。

```json

{

  "rules": {

    "user": {

      ".validate": "auth != null && newData.val() == auth.uid"

    }

  }

}

```
这条规则限制数据写入`/users`时，必须登录一个用户，且写入数据的值必须是登录的用户ID。
`.validate`规则不能替代App代码中对数据的校验。为了更好的性能和用户体验，你仍然需要在代码中对输入数据进行校验。

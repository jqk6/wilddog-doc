/*
Title: 6.理解规则表达式
Sort: 6
Tmpl : page-guide
*/

## 6.理解规则表达式
Wilddog提供全套的工具来支持您管理自己应用的安全性。这些工具使得用户认证、加强用户权限、规范用户输入变得简单。

####概述
安全是一个重大的话题，通常来讲，安全是一个应用开发过程中困难的部分。Wilddog使得你管理自己应用的安全性变得简单。我们关注某些部分的全部安全性，比如管理用户的密码。我们无法处理的复杂事情，我们会将其简化。例如，我们提供一种声明式的语言来管理应用的安全性。

本部分将介绍如何在Wilddog上构建安全应用。Wilddog应用运行更多的客户端代码，所以，我们提供的保护安全的方式可能比您之前用过的要复杂一些。

####认证
用户id是一个非常重要的概念。不同的用户拥有不同的数据，试试也有不同的容量。例如，在聊天程序中，每条消息都与消息创建者有关，用户可以删除自己发送的消息，但是不能删除其他用户发送的消息。管理应用安全性的第一步就是唯一标示用户，这个过程称之为认证。
Wilddog提供工具使得认证更加简单：
 - 集成微博、微信、微信公众账号和QQ认证
 - 邮件&密码登录和账户管理
 - 单次匿名登录
 - 自定义登录令牌，集成您自己的认证服务或SSO

向导的下一部分，用户认证，将介绍如何实现身份认证

授权：
唯一标示用户只是安全性的一部分。一旦知道了用户身份，就需要控制用户访问数据库的权限。
Wilddog提供声明式的语言指定规则，这些规则运行在服务器上，控制您应用的安全性。您可以通过选择控制台的规则表达式来编辑他们。
这些规则表达式可以让你方便的控制数据的访问。应用到一个节点上的规则对其所有的子节点都起作用。
``` json
{

  "rules": 
    "foo": {

      ".read": true,

      ".write": false

    }

  }

}

```
这个例子允许所有的用户读取`/foo/`节点和其子节点的内容，但是不允许更改它们。

规则表达式包含许多的内建变量和函数，你可以使用这些变量和函数构建自己的规则表达式。这些变量和函数可以使规则表达式拥有充分的权利和良好的灵活性，可以参考其他路径，服务器端时间戳以及更多其他的参考。
最重要的内建变量是`auth`，用户认证通过后被赋值。其中包含相关数据和`auth.uid`，`auth.uid`是全局唯一的、字母数字标识符，工作于整个过程。`auth`变量是许多规则的基础。
``` json
{

  "rules": {

    "users": {

      "$user_id": {

        ".write": "$user_id === auth.uid"

      }

    }

  }

}

```
这条规则要求写入到`/foo/`节点的数据必须是小于100个字符的字符串。

验证规则可以访问所有的内建变量和函数，例如`.read`和`.write`规则。可以使用这些规则来创建新的验证规则，用来了解数据库中的其他数据，如用户标识，服务器时间等信息。
``` json
{

  "rules": {

    "user": {

      ".validate": "auth != null && newData.val() === auth.uid"

    }

  }

}

```
这条规则授权`user_id`匹配动态路径中的`$user_id`的用户访问`/users/<auth.uid>/`节点数据。


####数据验证
所有的应用都没有固定的数据库模式。这使得开发过程中进行的修改变得容易，但是一旦应用发布，就需要保持数据的一致性。规则表达式中包含`.validate`规则，用来指定声明式的验证规则，如`.read`和`.write`规则。唯一的不同就是验证规则没有级联。
``` json
{

  "rules": {

    "foo": {

      ".validate": "newData.isString() && newData.val().length < 100"

    }

  }

}

```
这条规则要求写入到`/foo/`节点的数据必须是小于100个字符的字符串。

验证规则可以访问所有的内建变量和函数，例如`.read`和`.write`规则。可以使用这些规则来创建新的验证规则，用来了解数据库中的其他数据，如用户标识，服务器时间等信息。
```json
{

  "rules": {

    "user": {

      ".validate": "auth != null && newData.val() === auth.uid"

    }

  }

}

```
这条规则要求只有当前登录的用户可以写入`/user/`。

如果请求违反规则，则会返回错误。

验证规则并不是要取代应用中的验证代码，所以您最好还是要验证用户的输入，当用户离线时给予提示。

####了解更多
现在您已经对构建应用安全性有了粗略的了解。

规则表达式是一种有效且灵活控制应用访问权限的方式，该指南只涵盖了其中的一小部分，安全指南中会包含更详细的介绍，包含所有的内建函数、变量和特征，也包含示例讲解如何将它们应用于程序中。

您可以根据该指南不为应用编写综合规则，但是在您启动您的程序之前必须保证已经编写好规则。在您的应用正式使用之前指定一个安全性保护计划也是一个不错的选择，这样您只需要稍微重构一下您的数据就可以兼容这些规则。